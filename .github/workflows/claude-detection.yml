name: Claude Analysis Detection

on:
  issue_comment:
    types: [created]

jobs:
  detect-and-create-ui:
    if: |
      github.event.issue.pull_request && 
      github.event.comment.user.login == 'claude[bot]' &&
      (contains(github.event.comment.body, 'âŒ') || 
       contains(github.event.comment.body, 'âš ï¸') ||
       contains(github.event.comment.body, 'Issues') ||
       contains(github.event.comment.body, 'TODO'))
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Extract problems from Claude analysis
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const issues = [];
            
            // âŒ ã‚¨ãƒ©ãƒ¼ã®æŠ½å‡º
            const errorMatches = comment.match(/âŒ\s*([^\n]+)/g) || [];
            errorMatches.forEach((match, i) => {
              const content = match.replace(/âŒ\s*/, '').trim();
              issues.push({
                id: `error-${i}`,
                type: 'error',
                priority: 'high',
                emoji: 'ğŸ”´',
                content: content,
                originalMatch: match
              });
            });
            
            // âš ï¸ è­¦å‘Šã®æŠ½å‡º
            const warningMatches = comment.match(/âš ï¸\s*([^\n]+)/g) || [];
            warningMatches.forEach((match, i) => {
              const content = match.replace(/âš ï¸\s*/, '').trim();
              issues.push({
                id: `warning-${i}`,
                type: 'warning',
                priority: 'medium',
                emoji: 'ğŸŸ¡',
                content: content,
                originalMatch: match
              });
            });
            
            // TODOé …ç›®ã®æŠ½å‡º
            const todoMatches = comment.match(/TODO:\s*([^\n]+)/g) || [];
            todoMatches.forEach((match, i) => {
              const content = match.replace(/TODO:\s*/, '').trim();
              issues.push({
                id: `todo-${i}`,
                type: 'todo',
                priority: 'low',
                emoji: 'ğŸ“',
                content: content,
                originalMatch: match
              });
            });
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã®æŠ½å‡º
            const sections = [
              { pattern: /## ?(High Priority Issues|é«˜å„ªå…ˆåº¦ã®å•é¡Œ)([\s\S]*?)(?=\n## |$)/, type: 'high-priority', emoji: 'ğŸš¨' },
              { pattern: /## ?(Architecture Issues|ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å•é¡Œ)([\s\S]*?)(?=\n## |$)/, type: 'architecture', emoji: 'ğŸ—ï¸' },
              { pattern: /## ?(Medium Priority Issues|ä¸­å„ªå…ˆåº¦ã®å•é¡Œ)([\s\S]*?)(?=\n## |$)/, type: 'medium-priority', emoji: 'ğŸŸ ' }
            ];
            
            sections.forEach(section => {
              const match = comment.match(section.pattern);
              if (match && match[2] && match[2].trim()) {
                issues.push({
                  id: `section-${section.type}`,
                  type: section.type,
                  priority: section.type.includes('high') ? 'high' : 'medium',
                  emoji: section.emoji,
                  content: `${match[1]} detected with multiple items`,
                  sectionContent: match[2].trim()
                });
              }
            });
            
            console.log(`Extracted ${issues.length} issues from Claude analysis`);
            core.setOutput('issues', JSON.stringify(issues));
            core.setOutput('has_issues', issues.length > 0);
            core.setOutput('issue_count', issues.length);

      - name: Create interactive selection UI
        if: steps.extract.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = JSON.parse('${{ steps.extract.outputs.issues }}');
            const issueCount = '${{ steps.extract.outputs.issue_count }}';
            
            // Load template functions
            const CLAUDE_UI_TEMPLATE = `## ğŸ¤– Claudeå•é¡Œæ¤œå‡º â†’ Issueä½œæˆãƒ„ãƒ¼ãƒ«

**{{ISSUE_COUNT}}ä»¶ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ** 

ä½œæˆã—ãŸã„é …ç›®ã‚’ **ãƒã‚§ãƒƒã‚¯** ã—ã¦ãã ã•ã„ï¼š

{{ISSUE_LIST}}

---

### ğŸ¯ å®Ÿè¡Œæ–¹æ³•

**æ–¹æ³•1: ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ** (æ¨å¥¨)
1. ä¸Šè¨˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠ
2. ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ä»¥ä¸‹ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼š
   - ğŸš€ = é¸æŠã—ãŸé …ç›®ã‚’ **å€‹åˆ¥ã«issueä½œæˆ**
   - ğŸ“¦ = é¸æŠã—ãŸé …ç›®ã‚’ **1ã¤ã®issueã«ã¾ã¨ã‚ã¦ä½œæˆ**

**æ–¹æ³•2: ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ**
\`\`\`
/create-issues selected    # ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’ä½œæˆ
/create-issues all         # å…¨é …ç›®ã‚’ä½œæˆ  
/create-issues 1,3,5       # ç•ªå·æŒ‡å®šã§ä½œæˆ
\`\`\`

### âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
\`\`\`
/create-issues all --labels="bug,urgent" --assign=@username
\`\`\`

<details>
<summary>ğŸ“‹ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã®è©³ç´°</summary>

{{ISSUE_DETAILS}}

</details>

---
_æ¤œå‡ºID: \`{{COMMENT_ID}}\` | æ¤œå‡ºæ™‚åˆ»: {{TIMESTAMP}}_`;
            
            // Generate template variables
            const issueList = issues.map((issue, i) => 
              `- [ ] ${issue.emoji} **[${issue.priority.toUpperCase()}]** ${issue.content}`
            ).join('\n');
            
            const issueDetails = issues.map((issue, i) => `**${i + 1}. ${issue.content}**
- ã‚¿ã‚¤ãƒ—: ${issue.type}
- å„ªå…ˆåº¦: ${issue.priority}
${issue.sectionContent ? `- è©³ç´°: ${issue.sectionContent.substring(0, 200)}...` : ''}
`).join('\n');
            
            // Process template
            const interactiveComment = CLAUDE_UI_TEMPLATE
              .replace(/{{ISSUE_COUNT}}/g, issueCount)
              .replace(/{{ISSUE_LIST}}/g, issueList)
              .replace(/{{ISSUE_DETAILS}}/g, issueDetails)
              .replace(/{{COMMENT_ID}}/g, context.payload.comment.id)
              .replace(/{{TIMESTAMP}}/g, new Date().toISOString());
            
            const result = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: interactiveComment
            });
            
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’éš ã—ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ä¿å­˜
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `<!-- claude-issue-metadata
${Buffer.from(JSON.stringify({
  commentId: result.data.id,
  sourceCommentId: context.payload.comment.id,
  issues: issues,
  detectedAt: new Date().toISOString(),
  prNumber: context.issue.number
})).toString('base64')}
-->`
            });
            
            console.log(`Created interactive UI comment: ${result.data.html_url}`);

      - name: Log detection summary
        if: steps.extract.outputs.has_issues == 'true'
        run: |
          echo "âœ… Claude analysis detection completed"
          echo "ğŸ“Š Issues found: ${{ steps.extract.outputs.issue_count }}"
          echo "ğŸ”— PR: #${{ github.event.issue.number }}"
          echo "ğŸ‘¤ Detected from: ${{ github.event.comment.user.login }}"