name: Claude Issue Reaction Handler

on:
  issue_comment:
    types: [created, edited]

jobs:
  handle-checkbox-updates:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, 'Claudeæ¤œå‡ºã®å•é¡Œ â†’ Issueä½œæˆ') &&
      github.event.action == 'edited'
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - name: Check for auto-creation trigger
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’æ¤œå‡º
            const checkedItems = [];
            const lines = comment.split('\n');
            const issuePattern = /- \[(x)\] (.+)/;
            
            lines.forEach(line => {
              const match = line.match(issuePattern);
              if (match) {
                checkedItems.push({
                  content: match[2].replace(/^[ğŸ”´ğŸŸ¡ğŸ—ï¸ğŸš¨]\s*\*\*\[.+?\]\*\*\s*/, '').trim()
                });
              }
            });
            
            // 3ã¤ä»¥ä¸Šãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯è‡ªå‹•å®Ÿè¡Œã®ææ¡ˆ
            if (checkedItems.length >= 3) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ğŸ’¡ **è‡ªå‹•å®Ÿè¡Œã®ææ¡ˆ**

${checkedItems.length}é …ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®æ–¹æ³•ã§ä¸€æ‹¬å®Ÿè¡Œã§ãã¾ã™ï¼š

- ğŸš€ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§å€‹åˆ¥issueä½œæˆ
- ğŸ“¦ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§1ã¤ã®issueã«ã¾ã¨ã‚ã¦ä½œæˆ
- ã¾ãŸã¯ \`/create-issues-batch\` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œ

é¸æŠã•ã‚ŒãŸé …ç›®:
${checkedItems.map((item, i) => `${i + 1}. ${item.content}`).join('\n')}`
              });
            }

  provide-help:
    if: |
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/help') || 
       contains(github.event.comment.body, '/claude-help'))
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Show help information
        uses: actions/github-script@v7
        with:
          script: |
            const helpText = `## ğŸ¤– Claude Issue Creator - ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰

### ğŸ“‹ åŸºæœ¬çš„ãªä½¿ã„æ–¹

1. **ClaudeãŒå•é¡Œã‚’æ¤œå‡º** â†’ è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™
2. **ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠ** â†’ ä½œæˆã—ãŸã„é …ç›®ã«ãƒã‚§ãƒƒã‚¯ â˜‘ï¸
3. **ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ** â†’ ä»¥ä¸‹ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ :
   - ğŸš€ é¸æŠã—ãŸé …ç›®ã‚’å€‹åˆ¥ã«issueä½œæˆ
   - ğŸ“¦ é¸æŠã—ãŸé …ç›®ã‚’1ã¤ã®issueã«ã¾ã¨ã‚ã¦ä½œæˆ

### ğŸ¯ ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

\`\`\`
/create-issue ã‚¿ã‚¤ãƒˆãƒ«        # å˜ä¸€issueä½œæˆ
/create-issues all            # Claudeæ¤œå‡ºã®å…¨å•é¡Œã‚’issueåŒ–
/create-issues 1,3,5          # æŒ‡å®šç•ªå·ã®ã¿issueåŒ–
/help                         # ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
\`\`\`

### âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³

\`\`\`
--labels="bug,high-priority"  # ãƒ©ãƒ™ãƒ«è¿½åŠ 
--assign=@username            # ã‚¢ã‚µã‚¤ãƒ³
--milestone="v1.0"            # ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
\`\`\`

### ğŸ“ ä½¿ç”¨ä¾‹

\`\`\`
/create-issue Fix data architecture --labels="architecture,urgent" --assign=@orangekame3
\`\`\`

### ğŸ”„ è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼

1. Claudeåˆ†æå®Ÿè¡Œ â†’ å•é¡Œæ¤œå‡º
2. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠ
4. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã§å®Ÿè¡Œ
5. Issueè‡ªå‹•ä½œæˆ + çµæœé€šçŸ¥

---
_ã“ã®ãƒ˜ãƒ«ãƒ—ã¯ \`/help\` ã¾ãŸã¯ \`/claude-help\` ã§è¡¨ç¤ºã§ãã¾ã™_`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: helpText
            });

  batch-create-from-command:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/create-issues-batch')
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Find latest interactive comment and create issues
        uses: actions/github-script@v7
        with:
          script: |
            // æœ€æ–°ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });
            
            const interactiveComment = comments.data
              .filter(c => c.body.includes('Claudeæ¤œå‡ºã®å•é¡Œ â†’ Issueä½œæˆ'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
            
            if (!interactiveComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšClaudeåˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'
              });
              return;
            }
            
            // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸé …ç›®ã‚’æŠ½å‡º
            const lines = interactiveComment.body.split('\n');
            const selectedItems = [];
            const issuePattern = /- \[(x)\] (.+)/;
            
            lines.forEach(line => {
              const match = line.match(issuePattern);
              if (match) {
                selectedItems.push({
                  content: match[2].replace(/^[ğŸ”´ğŸŸ¡ğŸ—ï¸ğŸš¨]\s*\*\*\[.+?\]\*\*\s*/, '').trim()
                });
              }
            });
            
            if (selectedItems.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'
              });
              return;
            }
            
            // ãƒãƒƒãƒã§issueä½œæˆ
            const createdIssues = [];
            for (const item of selectedItems) {
              try {
                const issueTitle = item.content.length > 60 
                  ? `${item.content.substring(0, 60)}...`
                  : item.content;
                
                const created = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Claude Batch] ${issueTitle}`,
                  body: `## æ¦‚è¦
${item.content}

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- æ¤œå‡ºå…ƒ: PR #${context.issue.number}
- å®Ÿè¡Œè€…: @${context.payload.comment.user.login}
- å®Ÿè¡Œæ—¥æ™‚: ${new Date().toISOString()}
- å®Ÿè¡Œæ–¹æ³•: ãƒãƒƒãƒã‚³ãƒãƒ³ãƒ‰

---
_ã“ã®issueã¯ãƒãƒƒãƒã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ä½œæˆã•ã‚Œã¾ã—ãŸ_`,
                  labels: ['claude-detected', 'batch-created']
                });
                
                createdIssues.push(created.data);
              } catch (error) {
                console.error('Failed to create issue:', error);
              }
            }
            
            // çµæœå ±å‘Š
            if (createdIssues.length > 0) {
              const resultComment = `âœ… **ãƒãƒƒãƒä½œæˆå®Œäº†ï¼**

${createdIssues.map(issue => `- [#${issue.number}](${issue.html_url}): ${issue.title}`).join('\n')}

_${createdIssues.length}ä»¶ã®issueãŒãƒãƒƒãƒä½œæˆã•ã‚Œã¾ã—ãŸ_`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: resultComment
              });
            }