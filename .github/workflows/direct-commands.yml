name: Direct Issue Commands

on:
  issue_comment:
    types: [created]

jobs:
  handle-create-issue:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/create-issue')
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Parse single issue command
        uses: actions/github-script@v7
        with:
          script: |
            const command = context.payload.comment.body;
            const match = command.match(/\/create-issue\s+(.*)/s);
            
            if (!match) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ ã‚³ãƒãƒ³ãƒ‰å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\n\nä½¿ç”¨ä¾‹: `/create-issue ã‚¿ã‚¤ãƒˆãƒ«\\nè©³ç´°èª¬æ˜...`'
              });
              return;
            }
            
            const content = match[1].trim();
            const lines = content.split('\n');
            const title = lines[0] || `Issue from PR #${context.issue.number}`;
            const description = lines.slice(1).join('\n').trim() || 'PR ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ä½œæˆã•ã‚ŒãŸissue';
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            const labelMatch = command.match(/--labels?[=\s]+"?([^"\s]+)"?/);
            const assignMatch = command.match(/--assign[=\s]+"?([^"\s]+)"?/);
            const milestoneMatch = command.match(/--milestone[=\s]+"?([^"\s]+)"?/);
            
            const labels = ['manual-created'];
            if (labelMatch) {
              labels.push(...labelMatch[1].split(',').map(l => l.trim()));
            }
            
            const assignee = assignMatch ? assignMatch[1].replace('@', '') : null;
            const milestone = milestoneMatch ? milestoneMatch[1] : null;
            
            const issueBody = `## æ¦‚è¦
${description}

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- **ä½œæˆå…ƒ**: PR #${context.issue.number} - https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}
- **ä½œæˆè€…**: @${context.payload.comment.user.login}
- **ä½œæˆæ—¥æ™‚**: ${new Date().toISOString()}
- **ä½œæˆæ–¹æ³•**: æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰

## è©³ç´°
${description ? description : 'TODO: è©³ç´°ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„'}

---
_ã“ã®issueã¯æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ä½œæˆã•ã‚Œã¾ã—ãŸ_`;

            try {
              const issueData = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: issueBody,
                labels: labels.filter(Boolean)
              };
              
              if (assignee) issueData.assignees = [assignee];
              
              const created = await github.rest.issues.create(issueData);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âœ… **Issueä½œæˆå®Œäº†ï¼**

[#${created.data.number}](${created.data.html_url}): ${created.data.title}

- ä½œæˆè€…: @${context.payload.comment.user.login}
- ãƒ©ãƒ™ãƒ«: ${labels.join(', ')}
${assignee ? `- ã‚¢ã‚µã‚¤ãƒ³: @${assignee}` : ''}
- ä½œæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`
              });
              
            } catch (error) {
              console.error('Failed to create issue:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ Issueä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚

ã‚¨ãƒ©ãƒ¼: ${error.message}

ã‚³ãƒãƒ³ãƒ‰ä¾‹:
\`\`\`
/create-issue ãƒã‚°ä¿®æ­£ãŒå¿…è¦
ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®å‡¦ç†ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ --labels="bug,urgent" --assign=@username
\`\`\``
              });
            }

  handle-create-issues-command:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/create-issues')
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Find latest Claude UI
        id: find-ui
        uses: actions/github-script@v7
        with:
          script: |
            // æœ€æ–°ã®Claude UIã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });
            
            const uiComment = comments.data
              .filter(c => c.body.includes('Claudeå•é¡Œæ¤œå‡º â†’ Issueä½œæˆãƒ„ãƒ¼ãƒ«'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
            
            if (!uiComment) {
              core.setOutput('found', 'false');
              return;
            }
            
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ¡ãƒ³ãƒˆã‚‚æ¤œç´¢
            const metadataComment = comments.data.find(c => 
              c.body.includes('<!-- claude-issue-metadata')
            );
            
            core.setOutput('found', 'true');
            core.setOutput('ui_comment', JSON.stringify(uiComment));
            core.setOutput('metadata_comment', metadataComment ? JSON.stringify(metadataComment) : '{}');

      - name: Parse create-issues command
        if: steps.find-ui.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const command = context.payload.comment.body;
            const uiComment = JSON.parse('${{ steps.find-ui.outputs.ui_comment }}');
            
            // ã‚³ãƒãƒ³ãƒ‰è§£æ
            const match = command.match(/\/create-issues\s+(.*)/);
            const args = match ? match[1].trim() : '';
            
            // UIã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’å–å¾—
            const lines = uiComment.body.split('\n');
            const allItems = [];
            const selectedItems = [];
            
            lines.forEach((line, index) => {
              const itemMatch = line.match(/^- \[([ x])\] (.+)/);
              if (itemMatch) {
                const isChecked = itemMatch[1] === 'x';
                const content = itemMatch[2]
                  .replace(/^[ğŸ”´ğŸŸ¡ğŸ“ğŸš¨ğŸ—ï¸ğŸŸ ]\s*/, '')
                  .replace(/^\*\*\[.+?\]\*\*\s*/, '')
                  .trim();
                
                allItems.push({ content, index });
                if (isChecked) {
                  selectedItems.push({ content, index });
                }
              }
            });
            
            let itemsToCreate = [];
            
            if (args === 'all') {
              itemsToCreate = allItems;
            } else if (args === 'selected') {
              itemsToCreate = selectedItems;
            } else if (args.match(/^\d+(,\d+)*$/)) {
              // ç•ªå·æŒ‡å®š
              const indices = args.split(',').map(n => parseInt(n.trim()) - 1);
              itemsToCreate = indices.map(i => allItems[i]).filter(Boolean);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ ä¸æ­£ãªã‚³ãƒãƒ³ãƒ‰å½¢å¼ã§ã™ã€‚

ä½¿ç”¨å¯èƒ½ãªå½¢å¼:
- \`/create-issues all\` - å…¨é …ç›®ã‚’ä½œæˆ
- \`/create-issues selected\` - ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸé …ç›®ã‚’ä½œæˆ  
- \`/create-issues 1,3,5\` - æŒ‡å®šç•ªå·ã®é …ç›®ã‚’ä½œæˆ`
              });
              return;
            }
            
            if (itemsToCreate.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ ä½œæˆå¯¾è±¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠã™ã‚‹ã‹ã€æœ‰åŠ¹ãªç•ªå·ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚'
              });
              return;
            }
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            const labelMatch = command.match(/--labels?[=\s]+"?([^"\s]+)"?/);
            const assignMatch = command.match(/--assign[=\s]+"?([^"\s]+)"?/);
            
            const labels = ['claude-detected', 'command-created'];
            if (labelMatch) {
              labels.push(...labelMatch[1].split(',').map(l => l.trim()));
            }
            
            const assignee = assignMatch ? assignMatch[1].replace('@', '') : null;
            
            // Issueä½œæˆ
            const createdIssues = [];
            for (const item of itemsToCreate) {
              try {
                const title = item.content.length > 60 
                  ? `${item.content.substring(0, 60)}...`
                  : item.content;
                
                const body = `## æ¦‚è¦
${item.content}

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- **æ¤œå‡ºå…ƒ**: PR #${context.issue.number}
- **ä½œæˆè€…**: @${context.payload.comment.user.login}
- **ä½œæˆæ–¹æ³•**: ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ (\`${args}\`)
- **ä½œæˆæ—¥æ™‚**: ${new Date().toISOString()}

## å¯¾å¿œæ–¹é‡
TODO: å¯¾å¿œæ–¹é‡ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„

---
_ã“ã®issueã¯ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ä½œæˆã•ã‚Œã¾ã—ãŸ_`;
                
                const issueData = {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Claude Cmd] ${title}`,
                  body: body,
                  labels: labels.filter(Boolean)
                };
                
                if (assignee) issueData.assignees = [assignee];
                
                const created = await github.rest.issues.create(issueData);
                createdIssues.push(created.data);
                
              } catch (error) {
                console.error(`Failed to create issue for: ${item.content}`, error);
              }
            }
            
            // çµæœå ±å‘Š
            if (createdIssues.length > 0) {
              const resultComment = `âœ… **ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå®Œäº†ï¼**

ä½œæˆã•ã‚ŒãŸIssue (${createdIssues.length}ä»¶):
${createdIssues.map(issue => 
  `- [#${issue.number}](${issue.html_url}): ${issue.title}`
).join('\n')}

- å®Ÿè¡Œè€…: @${context.payload.comment.user.login}
- å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: \`/create-issues ${args}\`
- å®Ÿè¡Œæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: resultComment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ Issueã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
              });
            }

      - name: Show help if no UI found
        if: steps.find-ui.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ Claudeåˆ†æUIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚

**ä½¿ç”¨æ–¹æ³•:**
1. ã¾ãšClaudeï¼ˆ@claudeï¼‰ã«ã‚³ãƒ¼ãƒ‰åˆ†æã‚’ä¾é ¼ã—ã¦ãã ã•ã„
2. åˆ†æçµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã€è‡ªå‹•çš„ã«UIãŒç”Ÿæˆã•ã‚Œã¾ã™
3. ãã®å¾Œã§ \`/create-issues\` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™

**ã¾ãŸã¯ç›´æ¥ä½œæˆ:**
\`\`\`
/create-issue ã‚¿ã‚¤ãƒˆãƒ«
è©³ç´°èª¬æ˜...
\`\`\``
            });

  show-help:
    if: |
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/help') || 
       contains(github.event.comment.body, '/claude-help'))
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Display help information
        uses: actions/github-script@v7
        with:
          script: |
            const helpText = `## ğŸ¤– Claude Issue Creator ãƒ˜ãƒ«ãƒ—

### ğŸ“‹ åŸºæœ¬çš„ãªä½¿ã„æ–¹

**Step 1: Claudeåˆ†æã®å®Ÿè¡Œ**
\`\`\`
@claude ã“ã®PRã®å¤‰æ›´ã‚’åˆ†æã—ã¦å•é¡ŒãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„
\`\`\`

**Step 2: è‡ªå‹•UIç”Ÿæˆ**
- ClaudeãŒâŒâš ï¸ãªã©ã®å•é¡Œã‚’æ¤œå‡ºã™ã‚‹ã¨è‡ªå‹•çš„ã«UIãŒç”Ÿæˆã•ã‚Œã¾ã™

**Step 3: Issueä½œæˆ**
- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é …ç›®ã‚’é¸æŠ
- ğŸš€ï¼ˆå€‹åˆ¥ä½œæˆï¼‰ã¾ãŸã¯ğŸ“¦ï¼ˆã¾ã¨ã‚ã¦ä½œæˆï¼‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 

### ğŸ¯ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

**ç›´æ¥Issueä½œæˆ:**
\`\`\`
/create-issue ã‚¿ã‚¤ãƒˆãƒ«
è©³ç´°èª¬æ˜...

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ã
/create-issue ãƒã‚°ä¿®æ­£ --labels="bug,urgent" --assign=@username
\`\`\`

**Claudeæ¤œå‡ºå•é¡Œã‹ã‚‰ã®ä½œæˆ:**
\`\`\`
/create-issues all              # å…¨é …ç›®ã‚’ä½œæˆ
/create-issues selected         # ãƒã‚§ãƒƒã‚¯æ¸ˆã¿é …ç›®ã‚’ä½œæˆ
/create-issues 1,3,5           # æŒ‡å®šç•ªå·ã‚’ä½œæˆ
/create-issues all --labels="priority" --assign=@reviewer
\`\`\`

### âš™ï¸ åˆ©ç”¨å¯èƒ½ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³

- \`--labels="label1,label2"\` - ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
- \`--assign=@username\` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¢ã‚µã‚¤ãƒ³
- \`--milestone="v1.0"\` - ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’è¨­å®š

### ğŸ”„ è‡ªå‹•åŒ–ãƒ•ãƒ­ãƒ¼

1. **Claudeåˆ†æ** â†’ å•é¡Œæ¤œå‡º
2. **UIè‡ªå‹•ç”Ÿæˆ** â†’ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãã‚³ãƒ¡ãƒ³ãƒˆ
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ** â†’ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ“ä½œ
4. **ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ** â†’ ğŸš€ğŸ“¦ã§è‡ªå‹•Issueä½œæˆ
5. **çµæœé€šçŸ¥** â†’ ä½œæˆã•ã‚ŒãŸIssueã®ãƒªãƒ³ã‚¯è¡¨ç¤º

### ğŸ“ ã‚µãƒãƒ¼ãƒˆ

- \`/help\` ã¾ãŸã¯ \`/claude-help\` - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
- å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„

---
_Claude Issue Creator v2.0 - åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç‰ˆ_`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: helpText
            });