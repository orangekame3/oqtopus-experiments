name: Issue Creation Handler

on:
  issue_comment:
    types: [edited]

jobs:  
  handle-checkbox-reactions:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, 'Claudeå•é¡Œæ¤œå‡º â†’ Issueä½œæˆãƒ„ãƒ¼ãƒ«') &&
      github.event.action == 'edited'
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Parse checkbox selections
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const lines = comment.split('\n');
            const selectedItems = [];
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è§£æ
            lines.forEach((line, index) => {
              const checkedMatch = line.match(/^- \[x\] (.+)/);
              if (checkedMatch) {
                const content = checkedMatch[1]
                  .replace(/^[ğŸ”´ğŸŸ¡ğŸ“ğŸš¨ğŸ—ï¸ğŸŸ ]\s*/, '')  // çµµæ–‡å­—é™¤å»
                  .replace(/^\*\*\[.+?\]\*\*\s*/, '')   // å„ªå…ˆåº¦ã‚¿ã‚°é™¤å»
                  .trim();
                
                selectedItems.push({
                  index: index,
                  content: content,
                  originalLine: line
                });
              }
            });
            
            console.log(`Found ${selectedItems.length} selected items`);
            core.setOutput('selected_items', JSON.stringify(selectedItems));
            core.setOutput('has_selections', selectedItems.length > 0);
            core.setOutput('selection_count', selectedItems.length);

      - name: Monitor for reactions
        if: steps.parse.outputs.has_selections == 'true'
        id: monitor
        uses: actions/github-script@v7
        with:
          script: |
            const selectedItems = JSON.parse('${{ steps.parse.outputs.selected_items }}');
            const commentId = context.payload.comment.id;
            
            // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
            const reactions = await github.rest.reactions.listForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId
            });
            
            // ãƒœãƒƒãƒˆä»¥å¤–ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
            const userReactions = reactions.data.filter(r => 
              !r.user.login.includes('bot') && !r.user.login.includes('action')
            );
            
            const rocketReaction = userReactions.find(r => r.content === 'rocket');
            const packageReaction = userReactions.find(r => r.content === 'package');
            
            let action = null;
            if (rocketReaction) action = 'individual';
            else if (packageReaction) action = 'bundled';
            
            core.setOutput('action', action || 'none');
            core.setOutput('reactor', rocketReaction?.user.login || packageReaction?.user.login || 'none');
            
            return { action, selectedItems };

      - name: Create individual issues
        if: steps.monitor.outputs.action == 'individual'
        uses: actions/github-script@v7
        with:
          script: |
            const selectedItems = JSON.parse('${{ steps.parse.outputs.selected_items }}');
            const createdIssues = [];
            
            for (const item of selectedItems) {
              try {
                const title = item.content.length > 60 
                  ? `${item.content.substring(0, 60)}...`
                  : item.content;
                
                const body = `## æ¦‚è¦
${item.content}

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- **æ¤œå‡ºå…ƒ**: PR #${context.issue.number}
- **æ¤œå‡ºè€…**: Claude Code Analysis
- **ä½œæˆè€…**: @${{ steps.monitor.outputs.reactor }}
- **ä½œæˆæ—¥æ™‚**: ${new Date().toISOString()}
- **å…ƒã‚³ãƒ¡ãƒ³ãƒˆ**: ${context.payload.comment.html_url}

## å¯¾å¿œæ–¹é‡
TODO: å¯¾å¿œæ–¹é‡ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„

## é–¢é€£
- [ ] å•é¡Œã®è©³ç´°èª¿æŸ»
- [ ] ä¿®æ­£æ–¹é‡ã®æ¤œè¨
- [ ] å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨çµ±åˆ

---
_ã“ã®issueã¯Claudeåˆ†æçµæœã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_`;
                
                const created = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Claude] ${title}`,
                  body: body,
                  labels: ['claude-detected', 'auto-generated']
                });
                
                createdIssues.push(created.data);
                console.log(`Created issue #${created.data.number}: ${title}`);
                
              } catch (error) {
                console.error(`Failed to create issue for: ${item.content}`, error);
              }
            }
            
            // çµæœã‚’å ±å‘Š
            const resultComment = `âœ… **å€‹åˆ¥Issueä½œæˆå®Œäº†ï¼**

ä½œæˆã•ã‚ŒãŸIssue (${createdIssues.length}ä»¶):
${createdIssues.map(issue => 
  `- [#${issue.number}](${issue.html_url}): ${issue.title}`
).join('\n')}

ä½œæˆè€…: @${{ steps.monitor.outputs.reactor }}
ä½œæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: resultComment
            });

      - name: Create bundled issue
        if: steps.monitor.outputs.action == 'bundled'
        uses: actions/github-script@v7
        with:
          script: |
            const selectedItems = JSON.parse('${{ steps.parse.outputs.selected_items }}');
            
            const title = `[Claude Bundle] ${selectedItems.length}ä»¶ã®å•é¡Œæ¤œå‡º (PR #${context.issue.number})`;
            
            const body = `## æ¤œå‡ºã•ã‚ŒãŸå•é¡Œä¸€è¦§

${selectedItems.map((item, i) => `### ${i + 1}. ${item.content}

**å¯¾å¿œçŠ¶æ³**: ğŸ”² æœªå¯¾å¿œ

---`).join('\n\n')}

## å…¨ä½“çš„ãªå¯¾å¿œæ–¹é‡

- [ ] å„å•é¡Œã®è©³ç´°èª¿æŸ»
- [ ] å„ªå…ˆé †ä½ã®æ±ºå®š
- [ ] ä¿®æ­£è¨ˆç”»ã®ç­–å®š
- [ ] æ®µéšçš„ãªå®Ÿè£…

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- **æ¤œå‡ºå…ƒ**: PR #${context.issue.number}
- **æ¤œå‡ºè€…**: Claude Code Analysis  
- **ä½œæˆè€…**: @${{ steps.monitor.outputs.reactor }}
- **ä½œæˆæ—¥æ™‚**: ${new Date().toISOString()}
- **ç·å•é¡Œæ•°**: ${selectedItems.length}ä»¶

## é€²æ—ç®¡ç†

å„å•é¡Œã®è§£æ±ºå¾Œã¯ã€ä¸Šè¨˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

---
_ã“ã®issueã¯Claudeåˆ†æçµæœã‚’ã¾ã¨ã‚ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_`;
            
            try {
              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['claude-detected', 'bundled', 'auto-generated']
              });
              
              // çµæœã‚’å ±å‘Š
              const resultComment = `ğŸ“¦ **ãƒãƒ³ãƒ‰ãƒ«Issueä½œæˆå®Œäº†ï¼**

[#${created.data.number}](${created.data.html_url}): ${created.data.title}

- çµ±åˆã•ã‚ŒãŸå•é¡Œæ•°: ${selectedItems.length}ä»¶
- ä½œæˆè€…: @${{ steps.monitor.outputs.reactor }}
- ä½œæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}

ã“ã®issueã§å…¨ã¦ã®é¸æŠã•ã‚ŒãŸå•é¡Œã‚’ã¾ã¨ã‚ã¦ç®¡ç†ã§ãã¾ã™ã€‚`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: resultComment
              });
              
            } catch (error) {
              console.error('Failed to create bundled issue:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ ãƒãƒ³ãƒ‰ãƒ«Issueä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
              });
            }

      - name: Log completion
        if: steps.monitor.outputs.action != 'none'
        run: |
          echo "âœ… Issue creation completed"
          echo "ğŸ¯ Action: ${{ steps.monitor.outputs.action }}"
          echo "ğŸ‘¤ Executed by: ${{ steps.monitor.outputs.reactor }}"
          echo "ğŸ“Š Selected items: ${{ steps.parse.outputs.selection_count }}"